<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
<title>review confident ruby(delivering results)</title>
<meta content='' name='description'>
<meta content='width=device-width' name='viewport'>
<link href='/css/normalize.css' rel='stylesheet'>
<link href='/css/main.css' rel='stylesheet'>
<link href='/css/bootstrap.min.css' rel='stylesheet'>
<link href='/stylesheets/background.css' rel='stylesheet'>
<link href='/stylesheets/article.css' rel='stylesheet'>
<script src='/js/vendor/modernizr-2.6.1.min.js'></script>
<script src='/js/vendor/jquery-1.8.0.min.js'></script>
<script src='/js/bootstrap.min.js'></script>
<link href="/stylesheets/rouge.css" rel="stylesheet" type="text/css" />
<link href="/stylesheets/home.css" rel="stylesheet" type="text/css" />
</head>
<body>
<header>
<nav class='navbar navbar-default' role='navigation'>
<div class='navbar-header'>
<button class='navbar-toggle' data-target='.navbar-ex1-collapse' data-toggle='collapse' type='button'>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</button>
<a class='navbar-brand'></a>
</div>
<div class='collapse navbar-collapse navbar-ex1-collapse'>
<ul class='nav navbar-nav'>
<li>
<a href='/'>Home</a>
</li>
<li>
<a href='/feed.xml'>Feed</a>
</li>
<li>
<a href='/about'>About</a>
</li>
</ul>
</div>
</nav>
</header>
<section class='main'>
<div id='main' role='main'>
<div class='container'>
<article>
<div class='title'>
<h1 class='page-header text-center'>
review confident ruby(delivering results)
</h1>
</div>
<br>
<h2>介绍 Delivering Results</h2>

<p>为method的caller提供output</p>

<h2>Delivering Results的模式</h2>

<ol>
<li>Write total functions</li>
<li>Call back instead of returning</li>
<li>Represent failure with benign value</li>
<li>Represent failure with a special case object</li>
<li>Return a status object</li>
<li>Yield a status object</li>
<li>Signal early termination with throw</li>
</ol>

<h3>Write total functions</h3>

<p>当method可以有0，1或多个返回值时，应该都返回一个(有可能长度为0)collection，
这样使得处理结果时不需要考虑特殊情况</p>
<pre class="highlight ruby"><code>
<span class="k">def</span> <span class="nf">find_words</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">prefix</span><span class="p">.</span><span class="nf">empty?</span>
  <span class="n">magic_words</span> <span class="o">=</span> <span class="sx">%w[klaatu barada nikto xyzzy plugh]</span>
  <span class="n">words</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">readlines</span><span class="p">(</span><span class="s1">'/usr/share/dict/words'</span><span class="p">).</span>
    <span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chomp</span><span class="p">).</span><span class="nf">reject</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span> <span class="o">=~</span> <span class="sr">/'/</span><span class="p">}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">magic_words</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">?</span> <span class="n">prefix</span> <span class="p">:</span>
    <span class="n">words</span><span class="p">.</span><span class="nf">select</span><span class="p">{</span><span class="o">|</span><span class="n">w</span><span class="o">|</span> <span class="n">w</span> <span class="o">=~</span> <span class="sr">/\A</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="sr">/</span><span class="p">}</span>
  <span class="no">Array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">find_words</span><span class="p">(</span><span class="s1">'xyzzy'</span><span class="p">)</span>
<span class="c1"># =&gt; ["xyzzy"]</span>
</code></pre>

<h3>Call back instead of returning</h3>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">import_callback</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">)</span>
  <span class="k">unless</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchased_titles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">purchase</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchases</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="n">title</span><span class="p">,</span> <span class="ss">purchased_at: </span><span class="n">date</span><span class="p">)</span>
    <span class="n">import_callback</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">purchase</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c1"># ...</span>
<span class="n">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="p">,</span> <span class="n">purchase</span><span class="o">|</span>
  <span class="n">send_book_invitation_email</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">purchase</span><span class="p">.</span><span class="nf">title</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1"># ...</span>

</code></pre>

<h3>Represent failure with benign value</h3>
<pre class="highlight ruby"><code><span class="k">def</span> <span class="nf">render_sidebar</span>
  <span class="n">html</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="s2">"&lt;h4&gt;What we're thinking about...&lt;/h4&gt;"</span>
  <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="s2">"&lt;div id='tweets'&gt;"</span>
  <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="n">latest_tweets</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="s2">"&lt;/div&gt;"</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">latest_tweets</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
  <span class="c1"># ...fetch tweets...</span>
  <span class="k">rescue</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTPError</span>
    <span class="s2">""</span>
<span class="k">end</span>


</code></pre>

<h3>Represent failure with a special case object</h3>

<p>同上一章里的 Represent special cases as objects</p>

<h3>Return a status object</h3>

<p>command
method的输出可能多种情况，不仅仅是success/failure,这时要把输出表示为status
object</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ImportStatus</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">success</span><span class="p">()</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:success</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redundant</span><span class="p">()</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:redundant</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">end</span>
  <span class="kp">attr_reader</span> <span class="ss">:error</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@status</span> <span class="o">=</span> <span class="n">status</span>
    <span class="vi">@error</span> <span class="o">=</span> <span class="n">error</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">success?</span>
    <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:success</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">redundant?</span>
    <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:redundant</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">failed?</span>
    <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:error</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchased_titles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">redundant</span>
  <span class="k">else</span>
    <span class="n">purchase</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchases</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="n">title</span><span class="p">,</span> <span class="ss">purchased_at: </span><span class="n">date</span><span class="p">)</span>
    <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">success</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">error</span>
    <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">success?</span>
  <span class="n">send_book_invitation_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">result</span><span class="p">.</span><span class="nf">redundant?</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"Skipped </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">"</span>
<span class="k">else</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"Error importing </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">result</span><span class="p">.</span><span class="nf">error</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>

<h3>Yield a status object</h3>

<p>当一个command
method可能有多个输出，不仅仅是success/failure,我们不想它返回值，
我们可以把method的输出表示为一个带有callback style mehtods的status
object,并在caller yield 这个object</p>
<pre class="highlight ruby"><code><span class="n">result</span> <span class="o">=</span> <span class="n">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
<span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">success?</span>
  <span class="n">send_book_invitation_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
<span class="k">elsif</span> <span class="n">result</span><span class="p">.</span><span class="nf">redundant?</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"Skipped </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">"</span>
<span class="k">else</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"Error importing </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">result</span><span class="p">.</span><span class="nf">error</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

</code></pre>

<p>上面的代码有2个问题:</p>

<ol>
<li>违反了 Command/Query Separation(CQS)原理，command不应返回值。</li>
<li>而且不再能使用batch的方式，要使用batch的方式，我们必须先收集所有status
object到数组里，再迭代。</li>
</ol>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ImportStatus</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">success</span><span class="p">()</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:success</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redundant</span><span class="p">()</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:redundant</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="kp">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">end</span>
  <span class="kp">attr_reader</span> <span class="ss">:error</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@status</span> <span class="o">=</span> <span class="n">status</span>
    <span class="vi">@error</span> <span class="o">=</span> <span class="n">error</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">on_success</span>
    <span class="k">yield</span> <span class="k">if</span> <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:success</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">on_redundant</span>
    <span class="k">yield</span> <span class="k">if</span> <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:redundant</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">on_failed</span>
    <span class="k">yield</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@status</span> <span class="o">==</span> <span class="ss">:error</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchased_titles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">yield</span> <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">redundant</span>
  <span class="k">else</span>
    <span class="n">purchase</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">purchases</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="n">title</span><span class="p">,</span> <span class="ss">purchased_at: </span><span class="n">date</span><span class="p">)</span>
    <span class="k">yield</span> <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">success</span>
  <span class="k">end</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">error</span>
  <span class="k">yield</span> <span class="no">ImportStatus</span><span class="p">.</span><span class="nf">failed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">import_purchase</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="o">|</span>
  <span class="n">result</span><span class="p">.</span><span class="nf">on_success</span> <span class="k">do</span>
    <span class="n">send_book_invitation_email</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">result</span><span class="p">.</span><span class="nf">on_redundant</span> <span class="k">do</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"Skipped </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
  <span class="n">result</span><span class="p">.</span><span class="nf">on_error</span> <span class="k">do</span> <span class="o">|</span><span class="n">error</span><span class="o">|</span>
    <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"Error importing </span><span class="si">#{</span><span class="n">title</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">user_email</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">error</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<h3>Signal early termination with throw</h3>

</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'zyncrochinadevblog';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>
</div>
</section>
<footer>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(["_setAccount", "UA-44086232-1"]);
  _gaq.push(["_trackPageview"]);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</footer>
</body>
</html>
